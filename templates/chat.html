{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h4 class="text-center">
    {% if role == 'student' %}
      Chat with Admin
    {% else %}
      Chat with {{ student.name }}
    {% endif %}
  </h4>

  <div class="card mt-3">
    <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto;">
      {% if messages %}
        {% for msg in messages %}
          {% if msg.sender %}
            {% set sender_name = msg.sender.name %}
          {% elif msg.sender_id == current_user.id %}
            {% set sender_name = 'You' %}
          {% else %}
            {% set sender_name = 'Unknown' %}
          {% endif %}
          <div class="{% if msg.sender_id == current_user.id %}text-end text-primary{% else %}text-start text-success{% endif %} mb-2">
            <small><strong>{{ sender_name }}</strong></small><br>
            <span>{{ msg.message }}</span><br>
            <small class="text-muted">{{ msg.timestamp.strftime('%b %d, %Y %I:%M %p') }}</small>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No messages yet.</p>
      {% endif %}
    </div>
  </div>

  <form id="chat-form" class="mt-3"
        {% if role == 'student' and admin is defined %}
          data-receiver="{{ admin.id }}"
        {% elif role == 'admin' and student is defined %}
          data-receiver="{{ student.id }}"
        {% else %}
          data-receiver=""
        {% endif %}>
    <div class="input-group">
      <input type="text" id="message" class="form-control" placeholder="Type your message..." autocomplete="off">
      <button class="btn btn-primary" type="submit">Send</button>
    </div>
  </form>

  <div class="text-center mt-3">
    <a href="{{ url_for('student_dashboard') if role == 'student' else url_for('admin_dashboard') }}" class="btn btn-secondary">
      Back to Dashboard
    </a>
  </div>
</div>

<script>
const form = document.getElementById('chat-form');
const box = document.getElementById('chat-box');
const receiverAttr = form.getAttribute('data-receiver');
const receiverId = receiverAttr ? Number(receiverAttr) : null;

async function appendMessageHtml(senderName, text, isMine, timestamp) {
  const div = document.createElement('div');
  div.className = (isMine ? 'text-end text-primary mb-2' : 'text-start text-success mb-2');
  const timeHtml = timestamp ? `<div><small class="text-muted">${timestamp}</small></div>` : '';
  div.innerHTML = `<small><strong>${senderName}</strong></small><br><span>${text}</span>${timeHtml}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = document.getElementById('message');
  const message = input.value.trim();
  if (!message) return;
  if (!receiverId) { alert('No receiver assigned.'); return; }

  try {
    const res = await fetch('/send_message', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ receiver_id: receiverId, message })
    });
    const data = await res.json();
    if (data.success) {
      await appendMessageHtml('You', data.message, true, data.timestamp || null);
      input.value = '';
    } else {
      alert('Send failed: ' + (data.error || 'unknown'));
    }
  } catch (err) {
    console.error(err);
    alert('Send failed');
  }
});

// Auto-refresh chat-box every 3 seconds (fetches the rendered page and replaces #chat-box)
setInterval(async () => {
  try {
    const res = await fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const newBox = doc.getElementById('chat-box');
    if (newBox) box.innerHTML = newBox.innerHTML;
  } catch (err) {
    console.error('Chat refresh error:', err);
  }
}, 3000);
</script>
{% endblock %}
