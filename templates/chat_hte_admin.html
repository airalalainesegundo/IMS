{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow p-4">
    <h3 class="text-center text-primary">ðŸ’¬ Chat with Admin</h3>
    <p class="text-center">You are chatting as <b>{{ current_user.name or current_user.username }}</b> (HTE)</p>

    <div id="chatBox" class="border rounded p-3 mb-2" style="height: 400px; overflow-y: auto;">
      <p class="text-muted text-center">Loading messages...</p>
    </div>

    <form id="sendMessageForm">
      <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required>
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>

    <div class="text-center mt-3">
      <a href="{{ url_for('hte_dashboard') }}" class="btn btn-secondary">â¬… Back to Dashboard</a>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const chatBox = document.getElementById("chatBox");
  const form = document.getElementById("sendMessageForm");
  const input = document.getElementById("messageInput");
  let lastMessageId = null;
  let displayed = new Set();

  function appendMessage(msg){
    if(displayed.has(msg.id)) return;
    const align = msg.sender_role === "hte" ? "text-end" : "text-start";
    const color = msg.sender_role === "hte" ? "bg-primary text-white" : "bg-light";
    chatBox.innerHTML += `
      <div class="p-2 mb-1 rounded ${color} ${align}">
        <small><b>${msg.sender_name}:</b> ${msg.content}</small><br>
        <small class="text-muted">${msg.timestamp}</small>
      </div>`;
    displayed.add(msg.id);
    lastMessageId = msg.id;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function loadMessages(){
    fetch(`/get_admin_hte_messages/{{ current_user.id }}?after_id=${lastMessageId||''}`)
      .then(res=>res.json())
      .then(data=>{
        if(data.messages && data.messages.length>0){
          data.messages.forEach(m=>appendMessage(m));
        } else if(!lastMessageId) {
          chatBox.innerHTML = "<p class='text-muted text-center'>No messages yet.</p>";
        }
      });
  }

  form.addEventListener("submit", function(e){
    e.preventDefault();
    const msg = input.value.trim();
    if(!msg) return;
    fetch(`/send_hte_admin_message`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({content: msg})
    }).then(res=>res.json()).then(data=>{
      if(data.success){
        appendMessage({
          id: data.message_id,
          sender_name: "You",
          sender_role: "hte",
          content: msg,
          timestamp: data.timestamp
        });
        input.value = "";
      } else alert(data.message || "Failed to send message.");
    });
  });

  setInterval(loadMessages, 3000);
  loadMessages();
});
</script>
{% endblock %}
