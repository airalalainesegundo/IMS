{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow p-4">
    <h3 class="text-center text-primary">ðŸ’¬ Chat with {{ hte.name or hte.username }}</h3>
    <p class="text-center">You are chatting as <b>Admin</b></p>

    <div id="chatBox" class="border rounded p-3 mb-2" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
      <p class="text-muted text-center">Loading messages...</p>
    </div>

    <form id="sendMessageForm">
      <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required>
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>

    <div class="text-center mt-3">
      <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">â¬… Back to Dashboard</a>
    </div>
  </div>
</div>

<style>
.message-left {
    background-color: #e2e3e5;
    color: #000;
    padding: 10px 15px;
    border-radius: 15px 15px 15px 0;
    display: inline-block;
    max-width: 70%;
    margin-bottom: 5px;
}
.message-right {
    background-color: #0d6efd;
    color: white;
    padding: 10px 15px;
    border-radius: 15px 15px 0 15px;
    display: inline-block;
    max-width: 70%;
    margin-bottom: 5px;
}
.msg-container {
    display: flex;
    flex-direction: column;
}
.msg-left { justify-content: flex-start; }
.msg-right { justify-content: flex-end; align-items: flex-end; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const chatBox = document.getElementById("chatBox");
  const form = document.getElementById("sendMessageForm");
  const input = document.getElementById("messageInput");
  let lastMessageId = null;
  let displayed = new Set();

  function appendMessage(msg){
    if(displayed.has(msg.id)) return;
    displayed.add(msg.id);
    lastMessageId = msg.id;

    // Flip alignment: admin â†’ right, hte â†’ left
    let alignClass = "";
    let bubbleClass = "";
    if(msg.sender_role === "admin"){
        alignClass = "msg-right";
        bubbleClass = "message-right";
    } else {
        alignClass = "msg-left";
        bubbleClass = "message-left";
    }

    const msgDiv = document.createElement("div");
    msgDiv.classList.add("msg-container", alignClass);
    msgDiv.innerHTML = `<div class="${bubbleClass}">
                          <small><b>${msg.sender_name}:</b> ${msg.content}</small><br>
                          <small class="text-muted">${msg.timestamp}</small>
                        </div>`;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function loadMessages(){
    fetch(`/get_admin_hte_messages/{{ hte.id }}?after_id=${lastMessageId||''}`)
      .then(res=>res.json())
      .then(data=>{
        if(data.messages && data.messages.length>0){
          data.messages.forEach(appendMessage);
        } else if(!lastMessageId) {
          chatBox.innerHTML = "<p class='text-muted text-center'>No messages yet.</p>";
        }
      });
  }

  form.addEventListener("submit", function(e){
    e.preventDefault();
    const msg = input.value.trim();
    if(!msg) return;
    fetch(`/send_admin_hte_message/{{ hte.id }}`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({content: msg})
    }).then(res=>res.json()).then(data=>{
      if(data.success){
        appendMessage({
          id: data.message_id,
          sender_name: "You",
          sender_role: "admin",
          content: msg,
          timestamp: data.timestamp
        });
        input.value = "";
      } else alert("Failed to send message.");
    });
  });

  setInterval(loadMessages, 3000);
  loadMessages();
});
</script>
{% endblock %}
