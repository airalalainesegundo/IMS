{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-5">
  <div class="card p-4 shadow">
    <h3 class="text-center text-primary">Admin Dashboard</h3>
    <p class="text-center">Welcome, {{ current_user.name or current_user.username }} ğŸ§‘â€ğŸ’¼</p>

    <!-- Menu Buttons -->
    <div class="d-flex justify-content-around mb-4 flex-wrap">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#students" aria-expanded="false" aria-controls="students">
        ğŸ“‹ View all students
      </button>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#parents" aria-expanded="false" aria-controls="parents">
        ğŸ‘ª View all parents
      </button>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#htes" aria-expanded="false" aria-controls="htes">
        ğŸ¢ View all HTEs
      </button>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#endorsements" aria-expanded="false" aria-controls="endorsements">
        ğŸ“ Manage Endorsement Letters
      </button>
    
</button>


      </button>
    </div>
  </div>

  <!-- Students Section (Full Width) -->
  <div class="collapse show" id="students">
    <div class="card card-body mt-4 shadow-lg border-0">
      <h4 class="text-primary mb-3 text-center">All Students</h4>
      {% if students %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
          <thead class="table-primary">
            <tr>
              <th>Name</th>
              <th>Total Hours</th>
              <th>Remaining Hours</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <td class="fw-semibold">{{ student.name or student.username }}</td>
              <td>{{ "%.2f"|format(student.total_hours or 0) }}</td>
              <td>{{ "%.2f"|format(student.remaining_hours or 0) }}</td>
              <td>
                <div class="d-flex flex-wrap justify-content-center gap-1">
                  <!-- âœ… Fixed onclick -->
                  <button class="btn btn-outline-success btn-sm" onclick="showStudentAttendance('{{ student.id }}')">
                    ğŸ“… Attendance
                  </button>

                  {% if student.attendances | selectattr('hte_approved', 'equalto', True) | list | length > 0 %}
                    <a href="{{ url_for('admin_daily_log', student_id=student.id) }}" class="btn btn-outline-info btn-sm">ğŸ“˜ Daily Log</a>
                  {% else %}
                    <button class="btn btn-outline-secondary btn-sm" disabled>ğŸ“˜ Daily Log</button>
                  {% endif %}

                  <!-- ğŸ†• AR Button -->
                  <a href="{{ url_for('view_accomplishment_reports', student_id=student.id) }}" class="btn btn-outline-warning btn-sm">ğŸ“„ AR</a>

                  <a href="{{ url_for('admin_chat', student_id=student.id) }}" class="btn btn-outline-primary btn-sm">ğŸ’¬ Chat</a>
                  <a href="{{ url_for('video_call', student_id=student.id) }}" class="btn btn-outline-danger btn-sm">ğŸ¥ Video</a>
                  <button class="btn btn-outline-warning btn-sm">âœï¸ Edit</button>
                  <button class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸ Delete</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center">No students found.</p>
      {% endif %}

      <!-- ğŸ”½ Assign Students to HTE Section -->
      <h4 class="mt-4 text-primary text-center">Assign Students to HTE</h4>
      <div class="row justify-content-center mt-3">
        <div class="col-lg-6 col-md-8">
          <form id="assignForm" class="text-center">
            <select name="student_id" id="studentSelect" class="form-select mb-2" required>
              <option value="">Select Student</option>
              {% for student in students %}
                <option value="{{ student.id }}">{{ student.name }}</option>
              {% endfor %}
            </select>

            <select name="hte_id" id="hteSelect" class="form-select mb-2" required>
              <option value="">Select HTE</option>
              {% for hte in htes %}
                <option value="{{ hte.id }}">{{ hte.name }}</option>
              {% endfor %}
            </select>

            <button type="submit" class="btn btn-primary w-100 mt-2">Assign</button>
          </form>
          <div id="assignMessage" class="mt-2 text-center"></div>
        </div>
      </div>

      <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Assigned HTE</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
              <tr>
                <td>{{ student.name }}</td>
                <td>{{ student.username }}</td>
                <td>
                  {% if student.hte_id %}
                    {% set assigned_hte = htes | selectattr('id', 'equalto', student.hte_id) | first %}
                    {{ assigned_hte.name if assigned_hte else 'N/A' }}
                  {% else %}
                    <span class="text-muted">Not assigned</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <!-- ğŸ”¼ End Assign Section -->
    </div>
  </div>

  <!-- Parents Section -->
  <div class="collapse" id="parents">
    <div class="card card-body mt-4 shadow">
      <h4 class="text-primary mb-3 text-center">All Parents & Their Children</h4>
      {% if parents %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
          <thead class="table-primary">
            <tr>
              <th>ğŸ‘ª Parent Name</th>
              <th>Username</th>
              <th>ğŸ“˜ Child / Student</th>
            </tr>
          </thead>
          <tbody>
            {% for parent in parents %}
            <tr>
              <td>{{ parent.name }}</td>
              <td>{{ parent.username }}</td>
              <td>
                {% set children = students | selectattr('parent_id', 'equalto', parent.id) | list %}
                {% if children %}
                  {{ children | map(attribute='name') | join(', ') }}
                {% else %}
                  No child assigned
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center">No parents found.</p>
      {% endif %}
    </div>
  </div>

  <!-- HTEs Section -->
  <div class="collapse" id="htes">
    <div class="card card-body mt-4 shadow">
      <h4 class="text-primary mb-3 text-center">All HTEs</h4>
      {% if htes %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle text-center">
          <thead class="table-primary">
            <tr>
              <th>ğŸ¢ HTE Name</th>
              <th>ğŸ‘©â€ğŸ“ Students</th>
              <th>ğŸ’¬ Message</th>
              <th>ğŸ“ Important Files</th>
            </tr>
          </thead>
          <tbody>
            {% for hte in htes %}
            <tr>
              <td class="fw-semibold">{{ hte.name }} <span class="text-muted">({{ hte.username }})</span></td>
              <td>
                <button class="btn btn-outline-info btn-sm" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#studentsFor{{ hte.id }}"
                        aria-expanded="false"
                        aria-controls="studentsFor{{ hte.id }}">
                  View Students
                </button>
              </td>
              <td>
                <a href="{{ url_for('admin_chat_hte', hte_id=hte.id) }}" class="btn btn-outline-primary btn-sm">
                  ğŸ’¬ Message
                </a>
              </td>
              <td>
                <!-- Upload form -->
                <form method="post" action="{{ url_for('upload_hte_file', hte_id=hte.id) }}" enctype="multipart/form-data" class="d-flex flex-column align-items-center gap-2">
                  <input type="file" name="hte_file" class="form-control form-control-sm" required>
                  <button type="submit" class="btn btn-outline-success btn-sm">Upload</button>
                </form>

                <!-- Show uploaded files -->
                {% set hte_files = hte.files if hte.files else [] %}
                {% if hte_files %}
                <ul class="list-unstyled mt-2">
                  {% for file in hte_files %}
                    <li>
                      <a href="{{ url_for('download_file', filename=file) }}" target="_blank" class="text-decoration-none">
                        ğŸ“„ {{ file }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </td>
            </tr>

            <!-- Collapsible Student Row -->
            <tr class="collapse" id="studentsFor{{ hte.id }}">
              <td colspan="4" class="bg-light">
                {% set assigned_students = students | selectattr('hte_id', 'equalto', hte.id) | list %}
                {% if assigned_students %}
                  <ul class="list-group list-group-flush text-start">
                    {% for s in assigned_students %}
                      <li class="list-group-item">ğŸ‘©â€ğŸ“ {{ s.name }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-muted mb-0">No students assigned.</p>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center">No HTEs found.</p>
      {% endif %}
    </div>
  </div>

  <!-- Attendance Section for Admin -->
  <div class="collapse" id="attendanceSection">
    <div class="card card-body shadow">
      <h5 class="text-center text-primary mb-3">ğŸ“… Attendance Records of Students</h5>

      {% if attendance_records_by_student %}
        {% for student, records_by_month in attendance_records_by_student.items() %}
          <h6 class="mt-3">{{ student.name or student.username }}</h6>
          {% if records_by_month %}
          <div class="accordion mb-3" id="accordion-{{ student.id }}">
            {% for month, records in records_by_month.items() %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ student.id }}-{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ student.id }}-{{ loop.index }}">
                  {{ month }} ({{ records|length }} days)
                </button>
              </h2>
              <div id="collapse-{{ student.id }}-{{ loop.index }}" class="accordion-collapse collapse"
                   data-bs-parent="#accordion-{{ student.id }}">
                <div class="accordion-body p-0">
                  <table class="table table-bordered table-sm mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th>Timestamp</th>
                        <th>Attendance Picture</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for a in records %}
                      <tr>
                        <td>{{ a.timestamp.strftime('%B %d, %Y - %I:%M %p') }}</td>
                        <td>
                          {% if a.file_name %}
                          <a href="{{ url_for('download_file', filename=a.file_name) }}" target="_blank">
                            <img src="{{ url_for('download_file', filename=a.file_name) }}" alt="Attendance" width="100">
                          </a>
                          {% else %}
                            <span class="text-muted">None</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
            <p class="text-muted">No attendance records for this student.</p>
          {% endif %}
        {% endfor %}
      {% else %}
        <p class="text-muted text-center">No attendance records available.</p>
      {% endif %}
    </div>
  </div>

  <!-- Endorsements Section -->
  <div class="collapse" id="endorsements">
    <div class="card card-body mt-4 shadow">
      <h5>Endorsement Requests</h5>
      {% if endorsements %}
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th>Action</th>
            <th style="width:150px;">Approved Endorsement</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for req in endorsements %}
          <tr>
            <td>{{ req.student.name if req.student else "Unknown" }}</td>
            <td>{{ req.description }}</td>
            <td>{{ req.status }}</td>
            <td>
              <form method="post" action="{{ url_for('admin_endorsement', req_id=req.id) }}" enctype="multipart/form-data">
                <input type="file" name="endorsement_file" required class="form-control mb-2">
                <textarea name="admin_comment" placeholder="Add comment..." class="form-control mb-2"></textarea>
                <button type="submit" class="btn btn-success btn-sm">Send to Student</button>
              </form>
            </td>
            <td class="text-truncate" style="max-width:150px;">
              {% if req.endorsement_file %}
                <a href="{{ url_for('download_file', filename=req.endorsement_file) }}" target="_blank">{{ req.endorsement_file }}</a>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <form method="post" action="{{ url_for('delete_endorsement', req_id=req.id) }}" onsubmit="return confirm('Are you sure you want to delete this endorsement?');">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">No endorsement requests yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Logout -->
  <div class="mt-4 text-center">
    <a href="{{ url_for('logout') }}" class="btn btn-danger px-4">Logout</a>
  </div>
</div>

<!-- âœ… AJAX Script for Assign Form -->
<script>
document.getElementById("assignForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const messageBox = document.getElementById("assignMessage");
  messageBox.innerHTML = `<div class="alert alert-info">Processing...</div>`;
  try {
    const response = await fetch("/assign_hte", { method: "POST", body: formData });
    const result = await response.json();
    messageBox.innerHTML = `<div class="alert alert-${result.success ? 'success' : 'danger'}">${result.message}</div>`;
  } catch (error) {
    console.error('Error:', error);
    messageBox.innerHTML = `<div class="alert alert-danger">Failed to assign. Please try again.</div>`;
  }
});

// Function to filter attendance by student
function showStudentAttendance(studentId) {
  // Expand attendance section
  const attendanceSection = document.getElementById("attendanceSection");
  if (!attendanceSection.classList.contains("show")) {
    new bootstrap.Collapse(attendanceSection, { toggle: true });
  }

  // Collapse all students first
  const accordions = document.querySelectorAll('[id^="accordion-"]');
  accordions.forEach(acc => {
    if (!acc.id.endsWith(studentId)) {
      acc.querySelectorAll('.collapse').forEach(c => c.classList.remove('show'));
    }
  });

  // Open selected student's accordion months
  const studentAccordion = document.getElementById('accordion-' + studentId);
  if (studentAccordion) {
    studentAccordion.querySelectorAll('.collapse').forEach(c => c.classList.add('show'));
    studentAccordion.scrollIntoView({ behavior: 'smooth' });
  }
}
</script>
{% endblock %}
